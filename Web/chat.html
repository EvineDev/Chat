<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wabble Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body id="chat-body">
    <header>
        <h1>My Little Game Chat</h1>
    </header>
    <nav>
        <form action="/logout" method="post">
            <button>Logout</button>
        </form>
        <label for="channel-select"></label>
        <select name="channel" id="channel-select">
            <option value="Best Pony">Best Pony</option>
            <option value="Super Secret Place">Super Secret Place</option>
        </select>
    </nav>
    <section id="chat-box"></section>
    <section id="user-list">
        <h4>Online Users</h4>
        <div id="user-box"></div>
    </section>
    <section id="settings">
        <h4>Settings</h4>
        <form action="/upload-avatar" method="post" enctype="multipart/form-data">
            <label class="label-file" for="avatar">Upload avatar</label>
            <input class="input-file" type="file" id="avatar" name="avatar" accept="image/png, image/jpeg" />
            <button>Save</button>
        </form>
    </section>
    <section id="chat-input">
        <form action="/send-message" method="post">
            <label for="message"></label>
            <textarea type="text" name="message"></textarea>
            <button class="input-submit">Send</button>
        </form>
    </section>
    <script>
        let cookies = Object.fromEntries(document.cookie.split('; ').map(x => x.split('=')));
		let lastMessageId = null;

        function init() {
            setupChatboxInital();
			setupActiveUsers();

			//setInterval(setupMessagePolling, 1000);
		}

		function setupMessagePolling() {
			let chat = document.getElementById("chat-box");
			fetch("/message-poll/main/" + lastMessageId)
				.then(x => {
					if (x.status >= 400 && x.status < 500) {
						chat.appendChild(document.createTextNode("Unauthorized, please log-in"));
						throw x;
					} else if (x.status >= 200 && x.status < 300) {
						return x.text();
					} else {
						chat.appendChild(document.createTextNode("Server Error"));
						throw x;
					}
				}).then(x => {
					if (x == "") {
						return;
					}

					chat.innerHTML += x;

					let timeElements = chat.querySelectorAll("time");
					for (let time of timeElements) {
						time.innerText = `(${formatTime(time.dateTime)})`;
					}

					lastMessageId = chat.lastChild.dataset.messageId;

					// Fix: What a beatiful world
					setTimeout(() => { chat.scrollTop = 99999999; }, 400);
				});

		}

        function setupChatboxInital() {
            getChatHistory();

            function getChatHistory() {
                let chat = document.getElementById("chat-box");
                let chatNew = document.createElement("div");
				chatNew.id = "chat-box";

				fetch("/message-history/main")
					.then(x => {
						if (x.status >= 400 && x.status < 500) {
							chatNew.appendChild(document.createTextNode("Unauthorized, please log-in"));
							chat.replaceWith(chatNew);
							throw x;
						} else if (x.status >= 200 && x.status < 300) {
							return x.text();
						} else {
							chatNew.appendChild(document.createTextNode("Server Error"));
							chat.replaceWith(chatNew);
							throw x;
						}
					}).then(x => {
						chatNew.innerHTML = x;

						let timeElements = chatNew.querySelectorAll("time");
						for (let time of timeElements) {
							time.innerText = `(${formatTime(time.dateTime)})`;
						}

						lastMessageId = chatNew.lastChild.dataset.messageId;

						chat.replaceWith(chatNew);
						// Fix: What a beatiful world
						setTimeout(() => { chatNew.scrollTop = 99999999; }, 400);
					});
            }
        }

        function setupActiveUsers() {
            theThing();
            //setInterval(theThing, 5000);

            function theThing() {
                let users = document.getElementById("user-box");
                let usersNew = document.createElement("div");
				usersNew.id = "user-box";
				fetch("/active-users/main")
                    .then(x => {
                        if (x.status >= 400 && x.status < 500) {
                            throw x;
                        } else if (x.status >= 200 && x.status < 300) {
                            return x.text();
                        } else {
                            usersNew.appendChild(document.createTextNode("Server Error"));
                            users.replaceWith(usersNew);
                            throw x;
                        }
					}).then(x => {
						usersNew.innerHTML = x;
                        users.replaceWith(usersNew);
                    });
            }
		}

		function formatTime(dateString) {
			let date = new Date(dateString);
			let hour = date.getHours();
			if (hour < 10)
				hour = "0" + hour;
			let minutes = date.getMinutes();
			if (minutes < 10)
				minutes = "0" + minutes;
			let result = `${hour}:${minutes}`;

			return result;
		}

        init();
    </script>
</body>
</html>