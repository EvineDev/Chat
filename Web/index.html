<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wabble Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body id="chat-body">
    <header>
        <h1>My Little Game Chat</h1>
    </header>
    <nav>
        <form action="/logout" method="post">
            <button>Logout</button>
        </form>
        <label for="channel-select"></label>
        <select name="channel" id="channel-select">
            <option value="Best Pony">Best Pony</option>
            <option value="Super Secret Place">Super Secret Place</option>
        </select>
    </nav>
    <section id="chat-box"></section>
    <section id="user-list">
        <h4>Online Users</h4>
        <div id="user-box"></div>
    </section>
    <section id="settings">
        <h4>Settings</h4>
        <form action="/upload-avatar" method="post" enctype="multipart/form-data">
            <label for="avatar">Upload avatar</label>
            <input type="file" id="avatar" name="avatar" accept="image/png, image/jpeg" />
            <button>Submit</button>
        </form>
    </section>
    <section id="chat-input">
        <form action="/send-message" method="post">
            <label for="message"></label>
            <textarea type="text" name="message" required></textarea>
            <button>Send</button>
        </form>
    </section>
    <script>
        let cookies = Object.fromEntries(document.cookie.split('; ').map(x => x.split('=')));

        function init() {
            //getDocumentInformation();
            setupChatboxInital();
            setupActiveUsers();
        }

        function setupChatboxInital() {
            getChatHistory();
            //setInterval(getChatHistory, 1000);

            function getChatHistory() {
                let chat = document.getElementById("chat-box");
                let chatNew = document.createElement("div");
                chatNew.id = "chat-box";

                fetch("/api/message-history/main")
                    .then(x => {
                        if (x.status >= 400 && x.status < 500) {
                            chatNew.appendChild(document.createTextNode("Unauthorized, please log-in"));
                            chat.replaceWith(chatNew);
                            throw x;
                        } else if (x.status >= 200 && x.status < 300) {
                            return x.json();
                        } else {
                            chatNew.appendChild(document.createTextNode("Server Error"));
                            chat.replaceWith(chatNew);
                            throw x;
                        }
                    }).then(x => {
                        let nodes = x.map(m => {

                            let span1 = document.createElement("p");

                            let avatarElement = document.createElement("img");
                            avatarElement.className = "avatar-message";
                            avatarElement.src = "/api/avatar/" + m.userId;
                            span1.append(avatarElement);
                            

                            let timeElement = document.createElement("time");
                            timeElement.dateTime = m.created;
                            timeElement.innerText = formatTime(m.created);
                            span1.append(timeElement);

                            span1.append(" ");

                            let userElement = document.createElement("span");
                            userElement.innerText = m.username;
                            span1.append(userElement);
                            // Fix: Whitespace is not showing up, but might do a line thing anyway, 
                            //      but i probably want space in the copy paste.
                            span1.append(": ");
                            let span2 = document.createElement("p");

                            let messageElement = document.createElement("span");
                            messageElement.innerText = m.message;
                            span2.append(messageElement);

                            return [span1, span2];
                        });

                        nodes.map(x => {
                            chat.appendChild(x[0]);
                            chat.appendChild(x[1]);
                        });
                    });
            }

            function formatTime(dateString) {
                let date = new Date(dateString);
                let hour = date.getHours();
                if (hour < 10)
                    hour = "0" + hour;
                let minutes = date.getMinutes();
                if (minutes < 10)
                    minutes = "0" + minutes;
                let result = `${hour}:${minutes}`;

                return result;
            }
        }

        function setupActiveUsers() {
            theThing();
            //setInterval(theThing, 5000);

            function theThing() {
                let users = document.getElementById("user-box");
                let usersNew = document.createElement("div");
                usersNew.id = "user-box";
                fetch("/api/active-users/main")
                    .then(x => {
                        if (x.status >= 400 && x.status < 500) {
                            throw x;
                        } else if (x.status >= 200 && x.status < 300) {
                            return x.json();
                        } else {
                            usersNew.appendChild(document.createTextNode("Server Error"));
                            users.replaceWith(usersNew);
                            throw x;
                        }
                    }).then(x => {
                        x.map(username => {
                            let userElement = document.createElement("span");
                            userElement.innerText = username;
                            usersNew.appendChild(userElement);
                            usersNew.appendChild(document.createElement("br")); // Fix: remove
                        });

                        users.replaceWith(usersNew);
                    });
            }
        }
        
        function getDocumentInformation() {
            // Fix: Merge the results of html and css. We need proper css parsing first.
            let idList = {};
            let classList = {};

            let idListCss = {};
            let classListCss = {};

            iterateDocHtml(document);
            iterateDocCSS();

            printInfo();


            function printInfo() {
                console.log("-- html");

                for (let id in idList) {
                    console.log("#" + id);
                }

                for (let className in classList) {
                    console.log("." + className);
                }

                console.log("-- css");

                for (let id in idListCss) {
                    console.log(id);
                }

                for (let className in classListCss) {
                    console.log(className);
                }
            }

            function iterateDocHtml(d) {
                if (d.all === undefined) {
                    return;
                }
                for (let v of d.all) {
                    if (v.id !== "") {
                        if (idList[v.id]) {
                            console.log("Duplicate Id: #" + v.id);
                        }
                        idList[v.id] = true;
                    }

                    if (v.classList.length > 0) {
                        for (let c of v.classList) {
                            classList[c] = true;
                        }
                    }
                    iterateDocHtml(v);
                }
            }

            function iterateDocCSS() {
                // Fix: Does media queries affect what we get?
                for (let css of document.styleSheets[0].cssRules) {
                    // Fix: We need to parse the selectorText to get id / classes accurately
                    if (css.selectorText.includes("#")) {
                        idListCss[css.selectorText] = true;
                    }

                    if (css.selectorText.includes(".")) {
                        classListCss[css.selectorText] = true;
                    }
                }
            }
        }

        init();
    </script>
</body>
</html>